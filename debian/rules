#!/usr/bin/make -f

include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/class/autotools.mk

DEB_DH_INSTALL_SOURCEDIR=debian/tmp
DEB_DESTDIR=$(CURDIR)/debian/tmp
DEB_DH_STRIP_ARGS := --dbg-package=libaccounts-glib0
DEBDIR = ..

DEB_CONFIGURE_EXTRA_FLAGS += --enable-debug

ifeq (,$(findstring debug,$(DEB_BUILD_OPTIONS)))
    DEB_CONFIGURE_EXTRA_FLAGS += --disable-cast-checks
endif
ifneq (,$(findstring coverage,$(DEB_BUILD_OPTIONS)))
    SBOX_USE_CCACHE := no
    DEB_CONFIGURE_EXTRA_FLAGS += --enable-coverage
endif

export NO_DOCS := no
ifneq (,$(findstring nodocs,$(DEB_BUILD_OPTIONS)))
    export NO_DOCS = yes
endif

ifeq (,$(findstring yes,$(NO_DOCS)))
    DEB_CONFIGURE_EXTRA_FLAGS += --enable-gtk-doc
    DEB_INSTALL_DOCS_libaccounts-glib-doc := docs/reference/html
else 
    DEB_INSTALL_DOCS_libaccounts-glib-doc := docs/reference/html
endif

ifneq (,$(findstring parallel,$(DEB_BUILD_OPTIONS)))
    PARALLEL_JOBS := $(shell echo $(DEB_BUILD_OPTIONS) | \
            sed -e 's/.*parallel=\([0-9]\+\).*/\1/')
    ifeq ($(DEB_BUILD_OPTIONS),$(PARALLEL_JOBS))
        PARALLEL_JOBS := $(shell if [ -f /proc/cpuinfo ]; \
                    then echo `cat /proc/cpuinfo | grep 'processor' | wc -l`; \
                                else echo 1; fi)
    endif
    NJOBS := -j$(PARALLEL_JOBS)
endif
DEB_MAKE_ENVVARS := MAKEFLAGS=$(NJOBS)

debian/stamp-autotools-files:
	gtkdocize
	autoreconf -v --install
	touch debian/stamp-autotools-files

binary-arch:
	dh_builddeb  --destdir=$(DEBDIR)
	aegis-deb-add -control debian/libaccounts-glib0/DEBIAN/control .. debian/libaccounts-glib0.aegis=_aegis
	aegis-deb-add -control debian/libaccounts-glib0-test/DEBIAN/control .. debian/libaccounts-glib0-test.aegis=_aegis

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure
